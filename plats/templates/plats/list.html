{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/auth.css' %}">

<div class="container mt-4">
    <div class="auth-card card border-0 shadow-lg">
        <div class="card-header py-3 auth-card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-utensils me-2"></i>Liste des Plats
                </h3>
                <div>
                    <a href="{% url 'plats:plats-promotion' %}" class="btn btn-jaune me-2">
                        <i class="fas fa-tags me-2"></i>Voir les promotions
                    </a>
                    <a href="{% url 'plats:plat-create' %}" class="btn btn-vert me-2">
                        <i class="fas fa-plus-circle me-2"></i>Ajouter un plat
                    </a>
                </div>
            </div>
        </div>

        <div class="card-body p-4">
            <!-- Barre de recherche et filtres -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <form method="GET" class="row g-3" id="searchFilterForm">
                        <!-- Recherche par nom -->
                         <div class="col-md-4">
                             <input type="text" name="search" class="form-control" id="searchInput"
                                   placeholder="Rechercher un plat..." 
                                   value="{{ search_query|default:'' }}">
                        </div>
                        
                        <!-- Filtre par catégorie -->
                         <div class="col-md-2">
                             <select name="categorie" class="form-select" id="categorieSelect">
                                <option value="">Toutes catégories</option>
                                {% for code, nom in categories %}
                                <option value="{{ code }}" {% if categorie_filter == code %}selected{% endif %}>
                                    {{ nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Filtre par disponibilité -->
                         <div class="col-md-2">
                             <select name="disponibilite" class="form-select" id="disponibiliteSelect">
                                <option value="">Tous</option>
                                <option value="True" {% if disponibilite_filter == 'True' %}selected{% endif %}>Disponible</option>
                                <option value="False" {% if disponibilite_filter == 'False' %}selected{% endif %}>Indisponible</option>
                            </select>
                        </div>
                        
                        <!-- Filtre par promotion -->
                         <div class="col-md-2">
                             <select name="promotion" class="form-select" id="promotionSelect">
                                <option value="">Tous</option>
                                <option value="True" {% if promotion_filter == 'True' %}selected{% endif %}>En promotion</option>
                                <option value="False" {% if promotion_filter == 'False' %}selected{% endif %}>Sans promotion</option>
                            </select>
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="col-md-2">
                            <div class="d-flex">
                                <button type="submit" class="btn btn-vert me-2">
                                    <i class="fas fa-search"></i>
                                </button>
                                {% if search_query or categorie_filter or disponibilite_filter or promotion_filter %}
                                <a href="{% url 'plats:plat-list' %}" class="btn btn-secondary" title="Réinitialiser les filtres">
                                    <i class="fas fa-times"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Compteur de résultats -->
                <div class="col-md-4 text-end">
                    {% if search_query or categorie_filter or disponibilite_filter or promotion_filter %}
                    <p class="text-muted mb-0">
                        <i class="fas fa-filter me-1"></i>
                        {{ plats.count }} résultat{{ plats.count|pluralize }} trouvé{{ plats.count|pluralize }}
                    </p>
                    {% endif %}
                </div>
            </div>
            
            {% if plats %}
            <div class="row">
                {% for plat in plats %}
                <div class="col-lg-3 col-md-4 mb-3">
                    <div class="uniform-card plat-card" data-bs-toggle="modal" data-bs-target="#platModal">
                        <!-- Badge de promotion -->
                        {% if plat.est_en_promotion %}
                        <!-- Badge de promotion -->
                        <div class="uniform-badge">
                            <i class="fas fa-fire"></i>
                            {% if plat.pourcentage_reduction %}
                                -{{ plat.pourcentage_reduction }}%
                            {% else %}
                                PROMO
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="uniform-image-container">
                            {% if plat.photo %}
                            <img src="{{ plat.photo.url }}" class="uniform-image" alt="{{ plat.nom }}">
                            {% else %}
                            <div class="uniform-placeholder">
                                <i class="fas fa-utensils"></i>
                                <p>Aucune image</p>
                            </div>
                            {% endif %}
                        </div>
                        <div class="uniform-card-body">
                            <h5 class="uniform-card-title">{{ plat.nom }}</h5>
                            <p class="uniform-card-description">{{ plat.description|truncatechars:80 }}</p>
                                                         <div class="d-flex justify-content-between align-items-center">
                                 {% if plat.est_en_promotion %}
                                 <div>
                                     <span class="text-rouge text-decoration-line-through">{{ plat.prix }} FCFA</span>
                                     <br>
                                     <span class="text-vert fw-bold">{{ plat.get_prix_promotionnel }} FCFA</span>
                                 </div>
                                 {% else %}
                                 <span class="text-vert fw-bold">{{ plat.prix }} FCFA</span>
                                 {% endif %}
                                 <span class="badge bg-jaune">{{ plat.temps_preparation|default:"15" }} min</span>
                             </div>
                        </div>
                        <div class="uniform-card-footer">
                            <div class="btn-group btn-group-sm w-100">
                                <a href="{% url 'plats:plat-update' plat.pk %}" class="btn auth-submit-btn" onclick="event.stopPropagation();">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'plats:plat-detail' plat.pk %}" class="btn voir-btn" onclick="event.stopPropagation();">
                                    <i class="fas fa-eye"></i>
                                </a>
                                                                 <a href="{% url 'plats:promotion-form' plat.pk %}" class="btn btn-sm btn-jaune" 
                                    title="{% if plat.est_en_promotion %}Modifier la promotion{% else %}Configurer la promotion{% endif %}"
                                    onclick="event.stopPropagation();">
                                     <i class="fas fa-tags"></i>
                                 </a>
                                <a href="{% url 'plats:plat-delete' plat.pk %}" class="btn btn-rouge" onclick="event.stopPropagation();">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="guide-card">
                    <i class="fas fa-utensils fa-4x mb-3" style="color: var(--bs-jaune);"></i>
                    <h4>Aucun plat disponible</h4>
                    <p>Commencez par ajouter votre premier plat</p>
                    <a href="{% url 'plats:plat-create' %}" class="btn auth-submit-btn mt-3">
                        <i class="fas fa-plus-circle me-2"></i>Ajouter un plat
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Couleurs de texte personnalisées */
    .text-vert {
        color: var(--bs-vert) !important;
    }

    .text-jaune {
        color: var(--bs-jaune) !important;
    }

    .text-rouge {
        color: var(--bs-rouge) !important;
    }

    .text-font {
        color: var(--bs-font) !important;
    }

    .text-text {
        color: var(--bs-text) !important;
        font-size: 0.9rem;}

    .text-gray {
        color: var(--bs-gray) !important;
        font-size: 0.8rem;
    }

    .text-fontSecondary {
        color: var(--bs-fontSecondary) !important;
    }

    /* Arrière-plans personnalisés */
    .bg-vert {
        background-color: var(--bs-vert) !important;
    }

    .bg-jaune {
        background-color: var(--bs-jaune) !important;
    }

    .bg-rouge {
        background-color: var(--bs-rouge) !important;
    }

    .bg-font {
        background-color: var(--bs-font) !important;
    }

    .bg-text {
        background-color: var(--bs-text) !important;
    }

    .bg-fontSecondary {
        background-color: var(--bs-fontSecondary) !important;
    }

    /* Bordures personnalisées */
    .border-vert {
        border-color: var(--bs-vert) !important;
    }

    .border-jaune {
        border-color: var(--bs-jaune) !important;
    }

    .border-rouge {
        border-color: var(--bs-rouge) !important;
    }

    .border-font {
        border-color: var(--bs-font) !important;
    }

    .border-text {
        border-color: var(--bs-text) !important;
    }

    .border-fontSecondary {
        border-color: var(--bs-fontSecondary) !important;
    }

    /* Boutons personnalisés */
    .btn-vert {
        color: var(--bs-font);
        background-color: var(--bs-vert);
        border-color: var(--bs-vert);
    }

    .btn-vert:hover {
        color: var(--bs-font);
        background-color: #3e8e41;
        border-color: #3e8e41;
    }

    .btn-jaune {
        color: var(--bs-text);
        background-color: var(--bs-jaune);
        border-color: var(--bs-jaune);
    }

    .btn-jaune:hover {
        color: var(--bs-text);
        background-color: #e6ac00;
        border-color: #e6ac00;
    }

    .btn-rouge {
        color: var(--bs-font);
        background-color: var(--bs-rouge);
        border-color: var(--bs-rouge);
    }

    .btn-rouge:hover {
        color: var(--bs-font);
        background-color: #c21f35;
        border-color: #c21f35;
    }

    /* Badges personnalisés */
    .badge-vert {
        color: var(--bs-font);
        background-color: var(--bs-vert);
    }

    .badge-jaune {
        color: var(--bs-text);
        background-color: var(--bs-jaune);
    }

    .badge-rouge {
        color: var(--bs-font);
        background-color: var(--bs-rouge);
    }

    /* Alertes personnalisées */
    .alert-vert {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }

    .alert-jaune {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
    }

    .alert-rouge {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }

    /* Classes utilitaires supplémentaires */
    .hover-vert:hover {
        color: var(--bs-vert) !important;
    }

    .hover-bg-vert:hover {
        background-color: var(--bs-vert) !important;
    }

    .hover-border-vert:hover {
        border-color: var(--bs-vert) !important;
    }

    .link-vert {
        color: var(--bs-vert);
        text-decoration: none;
    }

    .link-vert:hover {
        color: #3e8e41;
        text-decoration: underline;
    }
    .plat-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    .plat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .square-img-container {
        position: relative;
        height: 200px;
        overflow: hidden;
        border-radius: 10px 10px 0 0;
    }
    .square-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .square-img-placeholder {
        width: 100%;
        height: 100%;
        background: var(--bs-jaune);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
    }
    .square-img-placeholder p {
        margin: 0;
        font-size: 0.7rem;
    }
    .img-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--bs-jaune);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.7rem;
        font-weight: bold;
    }
    .promotion-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: var(--bs-vert);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.7rem;
        font-weight: bold;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .guide-card {
        max-width: 500px;
        margin: 0 auto;
    }
</style>
<script>
// Soumission auto du formulaire au fil de la saisie / des changements
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('searchFilterForm');
    if (!form) return;

    const searchInput = document.getElementById('searchInput');
    const categorieSelect = document.getElementById('categorieSelect');
    const disponibiliteSelect = document.getElementById('disponibiliteSelect');
    const promotionSelect = document.getElementById('promotionSelect');

    let typingTimer;
    const doneTypingInterval = 400; // ms

    function submitForm() {
        if (form.requestSubmit) form.requestSubmit(); else form.submit();
    }

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(submitForm, doneTypingInterval);
        });
    }
    if (categorieSelect) categorieSelect.addEventListener('change', submitForm);
    if (disponibiliteSelect) disponibiliteSelect.addEventListener('change', submitForm);
    if (promotionSelect) promotionSelect.addEventListener('change', submitForm);
});
</script>
{% endblock %}
